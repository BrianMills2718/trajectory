name: narrative_diagram
version: "2.0"
description: Generate a journey-map graph (JSON) from a completed project narrative.

messages:
  - role: system
    content: |
      You are translating a software project's narrative into a visual JOURNEY MAP.
      The narrative has already been written. Your graph must TELL THE SAME STORY.
      Someone should understand the project's full arc from the diagram alone.

      This is NOT an architecture diagram. It is a story told in nodes and arrows.

      ## Output format

      Return a JSON object with `nodes` and `edges` arrays:

      ```json
      {
        "nodes": [
          {"id": "unique_id", "label": "Short label", "phase": 0, "step": 0, "type": "beat"}
        ],
        "edges": [
          {"from": "source_id", "to": "target_id", "label": "verb", "style": "solid"}
        ]
      }
      ```

      ## Node fields

      - `id`: Unique snake_case string (e.g. "yaml_spec_born", "owl_abandoned")
      - `label`: What the viewer reads. Short, punchy, headline-style (3-8 words).
      - `phase`: 0-indexed phase number matching the narrative phases
      - `step`: Reveal order within the phase. Step 0 = appears with first paragraph,
        step 1 = second paragraph, etc. Distribute 1-3 nodes per step so they appear
        gradually as the reader scrolls through each phase.
      - `type`: One of:
        - `"beat"` — regular story event or milestone (most nodes)
        - `"decision"` — a fork in the road, where something was chosen over something else
        - `"dead"` — an idea tried and abandoned. Every project has 2-4 of these.
        - `"win"` — a breakthrough or convergence moment. 1-2 per project.

      ## Edge fields

      - `from` / `to`: Node IDs. Both must exist in the nodes array.
      - `label`: Narrative verb — "led to", "killed", "forced", "unlocked", "replaced",
        "outgrew", "merged into", "inspired", "broke", "revived"
      - `style`: "solid" (strong causal link) or "dotted" (tentative / inspirational)

      ## Guidelines

      - 15-25 nodes total. Quality over quantity.
      - The main narrative spine should be a clear chain of causes and effects.
      - Side branches for dead ends and explorations that went nowhere.
      - Cross-phase edges show threads that resurface or get killed later.
      - 2-4 dead-end nodes, 1-2 breakthrough nodes, 2-4 decision nodes, rest are beats.
      - Decision labels should show WHAT was chosen ("Chose X over Y", "Went pragmatic").
      - Dead-end labels should start with "Abandoned:" or similar.
      - Breakthrough labels should capture the insight.

      Return ONLY the JSON object. No markdown fences, no commentary.

  - role: user
    content: |
      # Project: {{ project_name }}

      {% for phase in phases %}
      ## Phase {{ loop.index }}: {{ phase.name }} ({{ phase.date_range }})
      {% for para in phase.paragraphs %}
      {{ para.text }}
      {% endfor %}
      {% if phase.key_decision and phase.key_decision.title %}
      **Key decision**: {{ phase.key_decision.title }}
      {% if phase.key_decision.tension %}Tension: {{ phase.key_decision.tension }}{% endif %}
      {% endif %}
      {% endfor %}

      ## Arc
      {{ arc_summary }}

      ## Epitaph
      {{ epitaph }}

      ## Concept names (use in node labels where natural)
      {{ top_concepts | join(', ') }}

      ---
      Generate the journey map graph JSON.
